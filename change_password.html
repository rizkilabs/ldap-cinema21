<!DOCTYPE html>
<html>
  <head>
    <script>
      const token = localStorage.getItem("access_token");
      if(!token) {
        window.location.href = "index.html";
      }
    </script>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <title>Change Password</title>
    <style>
      /*
        /* Style change password form */
form {
display: flex;
flex-direction: column;
align-items: center;
margin-top: 50px;
}

input[id="current-password"] {
    margin-bottom: 20px;
    padding: 10px;
    width: 300px;
    font-size: 16px;
  }

  input[id="new-password"] {
    margin-bottom: 20px;
    padding: 10px;
    width: 300px;
    font-size: 16px;
  }

  input[id="confirm-password"] {
    margin-bottom: 20px;
    padding: 10px;
    width: 300px;
    font-size: 16px;
  }

  input[type="submit"] {
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  input[type="submit"]:hover {
    background-color: #45a049;
  }

  /* Style error message */
  #error-message {
    color: red;
    margin-bottom: 20px;
    font-size: 16px;
  }

  /* Style success message */
  #success-message {
    color: green;
    margin-bottom: 20px;
    font-size: 16px;
  }

  #current-password-id {
    position: relative;
  }

  .show-current-password {
    position: absolute;
    top: 0;
    right: 0;
    padding: 10px;
    cursor: pointer;
  }

  #new-password-id {
    position: relative;
  }

  .show-new-password {
    position: absolute;
    top: 0;
    right: 0;
    padding: 10px;
    cursor: pointer;
  }

  #confirm-password-id {
    position: relative;
  }

  .show-confirm-password {
    position: absolute;
    top: 0;
    right: 0;
    padding: 10px;
    cursor: pointer;
  }
</style>
</head>
<body>

  <!-- create log out button in top right corner -->
  <button onclick="logOut()" style="position: absolute; top: 10px; right: 10px;">Log Out</button>

  <!-- create confirm dialog before logout -->

  <form>
    <label for="current-password">Current Password:</label>
    <div id="current-password-id">
      <!-- <input type="password" onfocus="focusCurrPass()" onfocusout="focusOutCurrPass()" oninput="typeCurrPass()" onmouseover="mouseOverCurrPass();" onmouseout="mouseOutCurrPass();"  id="current-password" name="current-password" required> -->
      <input type="password" id="current-password" name="password" required>
      <a href="#" class="show-current-password" onclick="toggleCurrentPassword()">
        <span class="material-symbols-outlined">visibility_off</span>
      </a>
    </div>

    <label for="new-password">New Password:</label>
    <!-- <input type="password" onfocus="focusNewPass()" onfocusout="focusOutNewPass()" oninput="typeNewPass()" onmouseover="mouseOverNewPass();" onmouseout="mouseOutNewPass();" id="new-password" name="new-password" required> -->
    <div id="new-password-id">
      <!-- <input type="password" onfocus="focusCurrPass()" onfocusout="focusOutCurrPass()" oninput="typeCurrPass()" onmouseover="mouseOverCurrPass();" onmouseout="mouseOutCurrPass();"  id="current-password" name="current-password" required> -->
      <input type="password" id="new-password" name="password" required>
      <a href="#" class="show-new-password" onclick="toggleNewPassword()">
        <span class="material-symbols-outlined">visibility_off</span>
      </a>
    </div>

    <label for="confirm-password">Confirm New Password:</label>
    <!-- <input type="password" onfocus="focusConfirmPass()" onfocusout="focusOutConfirmPass()" oninput="typeConfirmPass()" onmouseover="mouseOverConfirmPass();" onmouseout="mouseOutConfirmPass();" id="confirm-password" name="confirm-password" required> -->
    <div id="confirm-password-id">
      <!-- <input type="password" onfocus="focusCurrPass()" onfocusout="focusOutCurrPass()" oninput="typeCurrPass()" onmouseover="mouseOverCurrPass();" onmouseout="mouseOutCurrPass();"  id="current-password" name="current-password" required> -->
      <input type="password" id="confirm-password" name="password" required>
      <a href="#" class="show-confirm-password" onclick="toggleConfirmPassword()">
        <span class="material-symbols-outlined">visibility_off</span>
      </a>
    </div>


    <input type="submit" value="Change Password">
  </form>
  
  <div id="error-message"></div>
  <div id="success-message"></div>
  
  <script>
      toggleCurrentPassword = () => {
        let showPassword = document.querySelector(".show-current-password");
        let password = document.getElementById("current-password");

        if (password.type === "password") {
          password.type = "text";
          showPassword.innerHTML = '<span class="material-symbols-outlined">visibility</span>';
        } else {
          password.type = "password";
          showPassword.innerHTML = '<span class="material-symbols-outlined">visibility_off</span>';
        }
      }

     toggleNewPassword = () => {
        let showPassword = document.querySelector(".show-new-password");
        let password = document.getElementById("new-password");

        if (password.type === "password") {
          password.type = "text";
          showPassword.innerHTML = '<span class="material-symbols-outlined">visibility</span>';
        } else {
          password.type = "password";
          showPassword.innerHTML = '<span class="material-symbols-outlined">visibility_off</span>';
        }
      }

      toggleConfirmPassword = () => {
        let showPassword = document.querySelector(".show-confirm-password");
        let password = document.getElementById("confirm-password");

        if (password.type === "password") {
          password.type = "text";
          showPassword.innerHTML = '<span class="material-symbols-outlined">visibility</span>';
        } else {
          password.type = "password";
          showPassword.innerHTML = '<span class="material-symbols-outlined">visibility_off</span>';
        }
      }

      focusNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "text";
      }
      
      focusOutNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "password";
      }

      typeNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "text";
      }

      mouseOverNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "text";
      }

      mouseOutNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "password";
      }

      focusConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "text";
      }
      
      focusOutConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "password";
      }

      typeConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "text";
      }

      mouseOverConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "text";
      }

      mouseOutConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "password";
      } 

    logOut = () => {
        Swal.fire({
          title: 'Are you sure you want to log out?',
          showDenyButton: false,
          confirmButtonText: `Yes`,
          showCancelButton: true,
          denyButtonText: `No`,
        }).then((result) => {
          /* Read more about isConfirmed, isDenied below */
          if (result.isConfirmed) {
            Swal.fire('Logged out!', '', 'success')
            localStorage.removeItem("access_token");
            window.location.href = "index.html";
          } else if (result.isDenied) {
            Swal.fire('Not logged out', '', 'info')
          }
        })
      }

    focusCurrPass = () => {
        var currPass = document.getElementById("current-password");
        currPass.type = "text";
      }
      
      focusOutCurrPass = () => {
        var currPass = document.getElementById("current-password");
        currPass.type = "password";
      }

      typeCurrPass = () => {
        var currPass = document.getElementById("current-password");
        currPass.type = "text";
      }

      mouseOverCurrPass = () => {
        var currPass = document.getElementById("current-password");
        currPass.type = "text";
      }

      mouseOutCurrPass = () => {
        var currPass = document.getElementById("current-password");
        currPass.type = "password";
      }

      focusNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "text";
      }

      focusOutNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "password";
      }

      typeNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "text";
      }

      mouseOverNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "text";
      }

      mouseOutNewPass = () => {
        var newPass = document.getElementById("new-password");
        newPass.type = "password";
      }

      focusConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "text";
      }

      focusOutConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "password";
      }

      typeConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "text";
      }

      mouseOverConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "text";
      }

      mouseOutConfirmPass = () => {
        var confirmPass = document.getElementById("confirm-password");
        confirmPass.type = "password";
      }



    const form = document.querySelector("form");
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");
  
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get("username");
  
    const usernameElement = document.createElement("p");
    usernameElement.innerText = "Logged in as: " + username;
    document.body.insertBefore(usernameElement, form);
  
    form.addEventListener("submit", event => {
      event.preventDefault();
  
      const currentPassword = document.getElementById("current-password").value;
      const newPassword = document.getElementById("new-password").value;
      const confirmPassword = document.getElementById("confirm-password").value;
  
      if (currentPassword === "" || newPassword === "" || confirmPassword === "") {
        errorMessage.innerText = "All fields are required.";
        successMessage.innerText = "";
        return;
      }
  
      if (newPassword !== confirmPassword) {
        errorMessage.innerText = "New password and confirm password do not match.";
        successMessage.innerText = "";
        return;
      }
  
      fetch("http://localhost:4000/activedirectories/update-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          username: username,
          currentPassword: currentPassword,
          password: newPassword
        })
      })
      .then(response => {
        response.json().then(data => {
          if(data.message === "Current password is wrong") {
            Swal.fire({
              icon: 'error',
              title: 'Curent password is wrong!',
              text: 'Please check your current password and try again.',
              timer: 5000,
            })
          } else if(data.message === "Password has been changed") {
            Swal.fire({
              icon: 'success',
              title: 'Password updated successfully!',
              text: 'You will be logged out in 2 seconds.',
              timer: 5000,
            })
            document.getElementById("current-password").value = "";
            document.getElementById("new-password").value = "";
            document.getElementById("confirm-password").value = "";
            setTimeout(() => {
              localStorage.removeItem("access_token");
              window.location.href = "index.html";
            }, 2000);
          }
        }).catch(error => {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Something went wrong!' + error,
            timer: 5000,
          })
        });
    });
  });
</script>
  